# Блок 9. OpenCV. HSV. (Заметки)

## Копирование массива
Чтобы скопировать массив (не просто ссылку на тот же массив записать в другую переменную), можно воспользоваться методом `.copy()`, встроенным в NumPy массивы.

```python
copy = image.copy()
```

## Создание пустого изображения
Для создания пустого изрбражения, нужно создать NumPy массив нужного размера, заполненный нулями.
```python
# Трёхмерый массив.
# Каждое число кодируется 8 битами (np.uint8) -- диапазон значений (0;255)
blank_image = numpy.zeros((height, width, 3), np.uint8)
```

[Документация `numpy.zeros()`](https://numpy.org/devdocs/reference/generated/numpy.zeros.html)

## Изменение диапазона пикселей одной командой
```python
# Пиксели половины изображения примут значение (0, 255, 0)
image[:, 0:width//2] = (0, 255, 0)
# Диапазон строк указан ":" это переберёт весь деиапазон.
# Диапазон столбцов указан "0:width//2" что переберёт столбцы от 0 до половины ширины.
# Обратите внимание на целочисленное деление "//2", чтобы граница диапазона оказалась целым числом
```

## Обработка событий
На открытом окне OpenCV можно обрабатывать события: нажатие кнопок, движение мышью, и пр.

[Пример обработки событий мыши. Документация OpenCV](https://docs.opencv.org/4.x/db/d5b/tutorial_py_mouse_handling.html)

### Обработка событий мыши
Для обработки событий нужно создать callback-функцию, которая будет вызываться каждый раз, когда происходит событие.

Какой именно должна быть эта callback-функция (какие аргументы принимать), указано в документации.\
[Документация `MouseCallback`](https://docs.opencv.org/4.x/d7/dfc/group__highgui.html#gab7aed186e151d5222ef97192912127a4)

```python
def my_callback(event, x, y, flags, userdata):
    print(event, x, y, flags, userdata)
    # Do something
```

Чтобы начать обрабатывать события нужно передать нашу функцию OpenCV при помощи метода `setMouseCallback()`.\
[Документация `setMouseCallback()`](https://docs.opencv.org/4.x/d7/dfc/group__highgui.html#ga89e7806b0a616f6f1d502bd8c183ad3e)

```python
cv2.setMouseCallback(window_name, collback_function)
```

После этого для указанного окна на все события мыши будет вызываться указанная функция.

#### Обработка флагов и типов события
В callback-функцию передаются параметры: event, flags. Эти параметры сами по себе являются бинарными числами, набором единиц и нулей. Если их вывести в консоль при помощи `print()`, то выведется число. Но чтобы узнать, какие именно флаги установлены или не установлены, нужно посмотреть на двоичное представление этого числа.
```python
print(bin(5)) # 0b101
```
Префикс `0b` означает, что число записано в двоичном виде.

Например, если в параметре `flags`, переданном в callback-функцию самый младший бит отвечает за то, нажата ли левая клавиша мыши и если она нажата, то переданное число будет `0b1` (число 1). А третий бит отвечает за нажатие на колёсико мыши, если нажать на колёсико мыши, то переданное число будет `0b100` (число 4). А если одновременно нажать и левую клавишу и колёсико, то переданное число будет `0b101` (число 5).

Для проверки состояния конкретного бита можно использвать побитовые операции. Операция `&` (побитовое `И`) возвращает число у которого 1 стоит только на тех местах, на которых у обоих переданных чисел был бит 1, а остальные биты -- 0. (Например, `0b100011 & 0b110001 = 0b100001`).

Чтобы проверить состояние конкретного флага, в OpenCV есть константы. Это числа, у которых все биты кроме одного нули, а 1 стоит в том бите, в котором передаётся нужная информация. Если сделать побитовое И (`&`) с таой константой, то мы получим 0, если флаг не установлен и получим ненулевое число, если флаг установлен.

```python
if flags & cv2.EVENT_FLAG_LBUTTON:
    print("Left mouse button is down")
if flags & cv2.EVENT_FLAG_MBUTTON:
    print("Middle mouse button is down")

# Это эквивалентно коду ниже
if flags & 0b1:
    print("Left mouse button is down")
if flags & 0b100:
    print("Middle mouse button is down")

if flags & 1:
    print("Left mouse button is down")
if flags & 4:
    print("Middle mouse button is down")
```

### Другие события и действия с GUI интерфейсом
Про другие события и действия с GUI интерфейсом можно почитать в документации OpenCV. Там есть и описание методов для работы с окнами (открыть, закрыть, подвинуть, приблизить, повесить обработчик событий, ...), также и описание типов данных, принимаемых этими иетодами (какими должны быть callback-функции, какими должны быть числовые параметры, какие должны быть переданы константы).\
[Документация OpenCV. High-level GUI.](https://docs.opencv.org/4.x/d7/dfc/group__highgui.html)

